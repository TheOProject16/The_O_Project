<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Theo ‚Äì Rechtschreibtrainer (4. Klasse)</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#9ca3af;
    --accent:#22c55e; --warn:#f59e0b; --err:#ef4444; --ok:#10b981;
    --ring: 0 0 0 3px rgba(34,197,94,.25);
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 800px at 20% -10%, #1f2945 0%, #0b1220 55%) no-repeat, var(--bg);
    color:var(--ink);
  }
  .wrap{max-width:1050px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:clamp(20px,3.2vw,32px);margin:0;font-weight:800;letter-spacing:.3px}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    border-radius:var(--radius); box-shadow:var(--shadow);
    padding:18px;
  }
  .grid{display:grid;gap:14px}
  @media (min-width:900px){ .grid{grid-template-columns: 1.1fr .9fr} }
  .themes{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  button{
    appearance:none;border:1px solid rgba(255,255,255,.12); background:#111827; color:var(--ink);
    padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;
    transition:.2s transform,.2s background,.2s border-color, .2s box-shadow;
  }
  button:hover{transform:translateY(-1px)}
  .accent{background:#16a34a;border-color:#16a34a}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0b132a;border:1px solid rgba(255,255,255,.08);font-size:13px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .textbox{
    line-height:1.9; font-size:18px; user-select:none;
    padding:16px;border-radius:12px;background:#0a1224;border:1px solid rgba(255,255,255,.08);
  }
  .token{padding:2px 4px;border-radius:6px;margin:0 2px;display:inline-block;border:1px solid transparent}
  .token.sel{background:rgba(34,197,94,.15);border-color:#22c55e;box-shadow:var(--ring)}
  .token.good{background:rgba(16,185,129,.18);border-color:#10b981}
  .token.bad{background:rgba(239,68,68,.18);border-color:#ef4444}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .progress{height:10px;background:#0a1328;border:1px solid rgba(255,255,255,.08);border-radius:99px;overflow:hidden}
  .progress>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0%}
  .score{font-variant-numeric:tabular-nums}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; background:#0a1328;border:1px solid rgba(255,255,255,.12); padding:2px 6px;border-radius:6px}
  footer{margin:18px 0 40px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üü¢ Theo ‚Äì Rechtschreibtrainer (4. Klasse)</h1>
      <div class="pill"><span>Modus:</span><strong id="modeLabel">Thema w√§hlen</strong></div>
    </header>

    <div class="grid">
      <section class="card">
        <h2 style="margin:0 0 8px 0">1) Thema w√§hlen</h2>
        <p class="muted" style="margin-top:0">W√§hle ein Thema. Du spielst pro Thema 10 Runden. In jedem Text sind <strong>genau 5 Fehler</strong>. Markiere alle falschen W√∂rter und klicke <em>Pr√ºfen</em>.</p>
        <div class="themes" id="themeButtons"></div>
      </section>

      <aside class="card">
        <h2 style="margin:0 0 8px 0">Hinweise</h2>
        <ul style="margin:0 0 8px 18px;line-height:1.7">
          <li>Fehlerarten: Gro√ü/Klein, <span class="kbd">b‚Üîd</span>, <span class="kbd">t‚Üîd</span>, Buchstaben doppeln/auslassen, ‚Äûdas/dass‚Äú, ‚Äûck/k‚Äú, ‚Äû√§/ae‚Äú.</li>
          <li>W√∂rter anklicken zum Markieren. Erneut klicken zum Aufheben.</li>
          <li><span class="kbd">Pr√ºfen</span> zeigt Treffer (gr√ºn) & Fehltreffer (rot).</li>
          <li>Nach 10 Runden bekommst du Punkte & eine Note.</li>
        </ul>
        <div class="row">
          <div class="pill score">Thema-Punkte: <span id="points">0</span>/50</div>
          <div class="pill">Runde: <span id="round">0</span>/10</div>
        </div>
        <div class="progress" style="margin-top:10px"><span id="bar"></span></div>
      </aside>
    </div>

    <section class="card" style="margin-top:14px">
      <h2 style="margin:0 0 8px 0">2) Lies den Text & markiere Fehler</h2>
      <div id="textBox" class="textbox" aria-live="polite">Bitte w√§hle zuerst ein Thema.</div>
      <div class="controls">
        <button id="checkBtn" class="">Pr√ºfen</button>
        <button id="nextBtn" class="">N√§chster Text</button>
        <button id="resetBtn" class="">Spiel zur√ºcksetzen</button>
      </div>
      <p id="feedback" class="muted" style="margin:10px 0 0 0"></p>
    </section>

    <section class="card" style="margin-top:14px">
      <h2 style="margin:0 0 8px 0">3) Ergebnis</h2>
      <div class="row">
        <div class="pill">Thema: <strong id="resultTheme">‚Äî</strong></div>
        <div class="pill">Punkte: <strong id="resultPoints">0</strong>/50</div>
        <div class="pill">Note: <strong id="resultGrade">‚Äî</strong></div>
      </div>
      <p class="muted" id="resultText" style="margin:10px 0 0 0">Starte ein Thema, um dein Ergebnis zu sehen.</p>
    </section>

    <footer>¬© 2025 ‚Äì Offline spielbar. Erstellt f√ºr Theo. Viel Spa√ü und Erfolg! ‚úåÔ∏è</footer>
  </div>

<script>
/* ==============================
   Datenbasis: 5 Themen, je 5 Basistexte (~300 Zeichen).
   Pro Thema werden zur Laufzeit 10 Runden erzeugt; die Basistexte
   k√∂nnen mehrfach mit neuen Fehlern verwendet werden.
=================================*/
const THEMES = [
  { id:"baustelle", title:"Baustelle" },
  { id:"bauernhof", title:"Bauernhof" },
  { id:"fahrraeder", title:"Fahrr√§der" },
  { id:"maschinenbau", title:"Maschinenbau" },
  { id:"rechtschreibung", title:"Wof√ºr man Rechtschreibung braucht" },
];

const BASE_TEXTS = {
  baustelle: [
`Auf der gro√üen Baustelle arbeiten fr√ºh am Morgen Bagger, Kr√§ne und Lastwagen zusammen. Die Zimmerleute vermessen die Balken, damit die W√§nde exakt stehen. Ein Polier erkl√§rt der Gruppe die Sicherheitsregeln. Alle tragen Helme, Handschuhe und feste Schuhe, damit niemand verletzt wird.`,
`Neben der Stra√üe entsteht ein neues Schulgeb√§ude. Maurer stapeln sorgf√§ltig Ziegel, w√§hrend der Kran schwere Paletten versetzt. Eine Absperrung sch√ºtzt Fu√üg√§nger. Der Beton wird frisch gemischt, damit die Decke gleich gegossen werden kann. Am Ende des Tages wird die Baustelle ordentlich aufger√§umt.`,
`Heute wird das Fundament gepr√ºft. Ein Ingenieur misst die Tiefe der Gr√§ben und kontrolliert die Bewehrung aus Stahl. Die Betonpumpe steht bereit. Ein Team legt Rohre f√ºr Wasser und Strom. Bevor die Platte gegossen wird, fotografiert die Bauleitung alles, damit sp√§ter dokumentiert ist, was im Boden liegt.`,
`Beim Stra√üenbau wird der Untergrund verdichtet. Eine Walze f√§hrt langsam vor und zur√ºck, bis der Boden eben ist. Danach kommt eine Schicht Schotter. Die Arbeiter markieren die Kanten mit Farbe. Sp√§ter wird Asphalt verteilt und mit der R√ºttelplatte gegl√§ttet, damit Autos sicher und leise dar√ºber fahren.`,
`Auf dem Neubau werden heute Fenster eingesetzt. Ein Monteur richtet die Rahmen millimetergenau aus. Dichtungen verhindern Zugluft und Regen. Danach wird die D√§mmung erg√§nzt. Auf dem Dach montiert ein Team die Dachziegel. Zum Schluss pr√ºft die Meisterin, ob alles sauber eingebaut und dokumentiert ist.`
  ],
  bauernhof: [
`Auf dem Bauernhof beginnt der Tag fr√ºh. Der Bauer f√ºttert die K√ºhe, pr√ºft das Heu und melkt im Stall. Die H√ºhner scharren im Hof, w√§hrend der Hund aufmerksam wacht. Sp√§ter f√§hrt der Traktor aufs Feld und zieht den Pflug. Am Abend werden die Tiere in den Stall gebracht und das Tor verschlossen.`,
`Im Obstgarten werden heute √Ñpfel geerntet. Kinder helfen mit K√∂rben und sortieren die Fr√ºchte. Die B√§uerin kocht daraus Mus und s√º√üen Saft. Bei den Schweinen wird frisches Stroh verteilt. Der Hofladen verkauft Eier, K√§se und Marmelade. Am Wochenende kommen Besucher zum Ponyreiten und Picknick.`,
`Im Fr√ºhjahr s√§en alle flei√üig. Der Boden wird gelockert und mit Saatgut best√ºckt. Regenw√ºrmer lockern die Erde, damit die Wurzeln Luft bekommen. Auf der Weide trinken die K√§lber bei ihren M√ºttern. Sp√§ter werden Z√§une repariert. Wenn ein Gewitter droht, holt die Familie die Tiere rechtzeitig rein.`,
`Heute werden Kartoffeln geerntet. Eine Maschine hebt die Knollen aus der Erde. Auf dem Wagen werden die Kartoffeln sortiert und in Kisten gef√ºllt. In der Scheune duftet es nach Heu. Der Hofkatze gef√§llt es auf den warmen Strohballen. Abends ist der Hof ruhig und der Mond steht hell √ºber den Feldern.`,
`Im Gem√ºsebeet wachsen Salat, M√∂hren und Bohnen. Der Regen hat gut getan, aber Unkraut w√§chst schnell. Mit der Harke wird behutsam gelockert. Die Gie√ükanne steht bereit. Aus reifen Tomaten kocht die Familie eine Suppe. Am Zaun h√§ngen Gartenger√§te ordentlich, damit niemand dar√ºber stolpert.`
  ],
  fahrraeder: [
`Fahrr√§der sind praktische Fahrzeuge. Mit Licht, Klingel und funktionierenden Bremsen f√§hrt man sicher. Vor der Fahrt pr√ºft man Luftdruck und Kette. Eine Schaltung hilft am Berg. Auf Radwegen achtet man auf Fu√üg√§nger. Ein Helm sch√ºtzt den Kopf. Wer die Regeln kennt, kommt entspannt und z√ºgig ans Ziel.`,
`Heute wird ein Fahrrad gewartet. Die Kette wird gereinigt und ge√∂lt. Danach stellt man die Bremsen nach, damit sie gleichm√§√üig greifen. Das Laufrad wird zentriert, damit es rund l√§uft. Ein neuer Schlauch wird eingesetzt. Zum Schluss leuchtet das R√ºcklicht hell und die Klingel klingt freundlich.`,
`Beim Ausflug f√§hrt die Gruppe durch den Wald. Wurzeln und Sand erfordern √úbung. In der Stadt sind Kreuzungen un√ºbersichtlich, deshalb zeigt ein Handzeichen die Richtung. Vor dem Abbiegen schaut man √ºber die Schulter. Ein reflektierender Mantel macht sichtbar. So bleibt die Fahrt f√ºr alle angenehm.`,
`Ein Mountainbike hat grobe Reifen und eine Federgabel. Auf Trails helfen gute Technik und Blickf√ºhrung. Ein Rennrad ist leicht und schnell, daf√ºr braucht man ruhige H√§nde am Lenker. Kinder lernen erst Balance, dann Bremsen und Schalten. Sicherheit geht vor Tempo, besonders bei N√§sse und Dunkelheit.`,
`Wer zur Schule radelt, spart Zeit und lernt Verantwortung. P√ºnktliche Abfahrt, sichere Route und ein Schloss gegen Diebstahl geh√∂ren dazu. Bei Regen sch√ºtzt eine Jacke, im Sommer Sonnencreme. Mit Freunden macht das Fahren mehr Spa√ü, aber R√ºcksicht ist wichtig. So kommt jede und jeder gut an.`
  ],
  maschinenbau: [
`Im Maschinenbau planen Ingenieurinnen und Ingenieure pr√§zise Bauteile. Am Computer entstehen Modelle, die sp√§ter gefr√§st oder gedruckt werden. Toleranzen entscheiden, ob Teile zusammenpassen. Werkstoffe wie Stahl, Aluminium oder Kunststoff werden je nach Aufgabe ausgew√§hlt und sorgf√§ltig gepr√ºft.`,
`Eine Fertigung beginnt mit einer Zeichnung. Ma√üe, Oberfl√§chen und Bohrungen sind genau festgelegt. Auf CNC-Maschinen werden Programme geladen. K√ºhlmittel sch√ºtzt Werkzeug und Werkst√ºck. Messger√§te pr√ºfen die Qualit√§t. Erst wenn alle Werte stimmen, wird die Serie freigegeben und dokumentiert.`,
`Ein Getriebe √ºbertr√§gt Drehmoment. Zahnr√§der greifen ineinander, Schmierung verhindert Verschlei√ü. Eine Welle wird gelagert, damit sie ruhig l√§uft. Geh√§use d√§mpfen Ger√§usche. Bei Pr√ºfst√§nden wird mit Sensoren gemessen. Daten zeigen, ob die Konstruktion zuverl√§ssig funktioniert und sicher bleibt.`,
`Roboter helfen bei schweren oder eint√∂nigen Aufgaben. Sie schwei√üen, lackieren oder montieren Bauteile. Menschen √ºberwachen, programmieren und kontrollieren die Ergebnisse. Schutzz√§une sichern den Bereich. Wenn etwas auff√§llig ist, wird angehalten und ordentlich nachgebessert, bevor es weitergeht.`,
`Nach dem Zusammenbau folgt ein Testlauf. Ein Motor startet, Temperaturen und Schwingungen werden beobachtet. Kleine Lecks werden abgedichtet. Eine Checkliste wird Punkt f√ºr Punkt abgearbeitet. Erst danach wird ausgeliefert. Klare Dokumentation hilft sp√§ter bei Wartung, Reparatur und Verbesserungen.`
  ],
  rechtschreibung: [
`Rechtschreibung braucht man √ºberall: in Nachrichten, Berichten und Bewerbungen. Wer Regeln kennt, wirkt sicher und h√∂flich. Gro√üschreibung zeigt den Anfang von S√§tzen und wichtigen Nomen. Geteilte oder Zusammenschreibung kann Bedeutung √§ndern. √úbung hilft, Fehler zu vermeiden und Texte klar zu machen.`,
`In der Schule und im Beruf ist richtiges Schreiben wichtig. Aufgabenhefte, E-Mails und Protokolle sollen verst√§ndlich sein. Wer W√∂rterbuch oder Nachschlage-App nutzt, lernt schnell. Auch langsames, genaues Lesen hilft. Wer zweifelt, fragt nach. Gute Rechtschreibung spart Zeit und verhindert Missverst√§ndnisse.`,
`Beim Chatten tippt man oft schnell. Abk√ºrzungen sind praktisch, aber im Aufsatz passt das nicht. Satzzeichen ordnen Gedanken. Bei l√§ngeren Texten hilft ein Plan. Danach pr√ºft man Rechtschreibung und Grammatik. Mit ruhigem Tempo und Pausen erkennt man mehr. Am Ende liest man den Text noch einmal laut vor.`,
`Rechtschreibung ist Teamarbeit mit der Grammatik. Verben ver√§ndern ihre Form, Nomen haben F√§lle und Artikel. Zusammengesetzte W√∂rter schreibt man meistens zusammen. Fremdw√∂rter lernt man mit Beispielen. Wer regelm√§√üig liest, merkt sich Schreibweisen leichter. So werden Texte pr√§zise und gut verst√§ndlich.`,
`Auch sp√§ter braucht man gute Texte: Bewerbungen, Vertr√§ge, Anleitungen. Wer ordentlich schreibt, zeigt Respekt. Korrekturprogramme helfen, ersetzen aber nicht den eigenen Blick. Fehler passieren allen. Wichtig ist, dass man sie findet, erkl√§rt und verbessert. So wird man Schritt f√ºr Schritt sicherer.`
  ]
};

/* =========================================
   Spielzustand & UI-Elemente
========================================= */
const el = (id)=>document.getElementById(id);
const textBox = el('textBox');
const feedback = el('feedback');
const pointsEl = el('points');
const roundEl = el('round');
const bar = el('bar');
const modeLabel = el('modeLabel');
const resultTheme = el('resultTheme');
const resultPoints = el('resultPoints');
const resultGrade = el('resultGrade');
const resultText = el('resultText');
const themeButtonsWrap = el('themeButtons');
const checkBtn = el('checkBtn');
const nextBtn = el('nextBtn');
const resetBtn = el('resetBtn');

let state = {
  theme: null,
  round: 0,
  points: 0,
  tokens: [],
  answerIdx: new Set(),
  selectedIdx: new Set(),
  locked: false,
  usedIdx: [] // welche Basistexte zuletzt genutzt wurden
};

/* =========================================
   Hilfsfunktionen
========================================= */
// Tokenizer: trennt W√∂rter & Satzzeichen, bewahrt Reihenfolge
function tokenize(text){
  const parts = text.split(/(\s+)/); // behalte Leerzeichen-Bl√∂cke
  const tokens = [];
  for(const part of parts){
    if(part.trim()===""){
      tokens.push({t:part, isWord:false});
    }else{
      // W√∂rter ggf. mit anh√§ngender Interpunktion trennen
      const sub = part.match(/[A-Za-z√Ñ√ñ√ú√§√∂√º√ü\-‚Äì‚Äî0-9]+|[^\sA-Za-z√Ñ√ñ√ú√§√∂√º√ü0-9]/g) || [part];
      for(const s of sub){
        const isWord = /[A-Za-z√Ñ√ñ√ú√§√∂√º√ü0-9]/.test(s);
        tokens.push({t:s, isWord});
      }
    }
  }
  return tokens;
}

function joinTokens(tokens){ return tokens.map(x=>x.t).join(''); }

// Zufall
const rnd = (n)=>Math.floor(Math.random()*n);
function choice(arr){ return arr[rnd(arr.length)]; }

// Ein paar Fehler-Transformationen
function lowerNoun(word){ // Gro√ü ‚Üí klein
  if(/^[A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]+$/.test(word)) return word[0].toLowerCase()+word.slice(1);
  return null;
}
function swapBD(word){
  if(/[bd]/i.test(word)){
    return word.replace(/[bd]/gi, c => (c===c.toLowerCase() ? (c==='b'?'d':'b') : (c==='B'?'D':'B')));
  }
  return null;
}
function swapTD(word){
  if(/[td]/i.test(word)){
    return word.replace(/[td]/gi, c => (c===c.toLowerCase() ? (c==='t'?'d':'t') : (c==='T'?'D':'T')));
  }
  return null;
}
function dropDouble(word){ // Buchstabe entfernen oder doppeln
  if(word.length<4) return null;
  const i = Math.max(1, Math.min(word.length-2, rnd(word.length-2)+1));
  if(Math.random()<0.5){
    return word.slice(0,i)+word.slice(i+1);
  }else{
    return word.slice(0,i)+word[i]+word.slice(i);
  }
}
function dasDass(word){
  if(word==='das') return 'dass';
  if(word==='dass') return 'das';
  if(word==='Das') return 'Dass';
  if(word==='Dass') return 'Das';
  return null;
}
function ckK(word){
  if(/ck/.test(word)) return word.replace('ck','k');
  if(/ck/.test(word.toLowerCase())) return word.replace(/ck/i,'k');
  if(/[kK][aou√§√∂√º]/.test(word) && Math.random()<0.4){ // gelegentlich k->ck
    return word.replace(/k/,'ck');
  }
  return null;
}
function aeUmlaut(word){
  if(/√§/.test(word)) return word.replace(/√§/g,'ae');
  if(/Ae/.test(word)) return word.replace(/Ae/g,'√Ñ');
  if(/ae/.test(word)) return word.replace(/ae/g,'√§');
  if(/[√Ñ]/.test(word)) return word.replace(/√Ñ/g,'Ae');
  return null;
}

// w√§hlt 5 Wort-Indizes, die manipulierbar sind
function pickErrorPositions(tokens){
  const candidates = [];
  tokens.forEach((tok,i)=>{
    if(tok.isWord && /^[A-Za-z√Ñ√ñ√ú√§√∂√º√ü\-‚Äì‚Äî]+$/.test(tok.t)) candidates.push(i);
  });
  // mischen
  for(let i=candidates.length-1;i>0;i--){ const j=rnd(i+1); [candidates[i],candidates[j]]=[candidates[j],candidates[i]]; }
  return candidates;
}

// produziert genau 5 Fehler und liefert Antwort-Indizes
function injectErrors(tokens){
  const tks = tokens.map(x=>({t:x.t, isWord:x.isWord}));
  const answerIdx = new Set();
  const positions = pickErrorPositions(tks);
  const transforms = [lowerNoun, swapBD, swapTD, dropDouble, dasDass, ckK, aeUmlaut];
  let made = 0, tries = 0;
  while(made<5 && tries<500 && positions.length){
    const i = positions[rnd(positions.length)];
    const word = tks[i].t;
    if(!tks[i].isWord) { tries++; continue; }
    // probiere ein paar beliebige Transformationen
    const shuffled = [...transforms].sort(()=>Math.random()-0.5);
    let changed = null;
    for(const fn of shuffled){
      const cand = fn(word);
      if(cand && cand!==word && /^[A-Za-z√Ñ√ñ√ú√§√∂√º√ü\-‚Äì‚Äî]+$/.test(cand)){
        changed = cand; break;
      }
    }
    if(changed){
      tks[i].t = changed;
      answerIdx.add(i);
      made++;
      // entferne i aus Positionen, um Doppelbearbeitung zu meiden
      const idx = positions.indexOf(i);
      if(idx>=0) positions.splice(idx,1);
    }else{
      tries++;
    }
  }
  // Falls weniger als 5 gelungen: einfache Notfallregel (Buchstabe doppeln)
  let k=0;
  while(made<5 && k<tokens.length){
    const i = positions[k++] ?? rnd(tokens.length);
    if(!tks[i] || !tks[i].isWord) continue;
    const w = tks[i].t;
    if(w.length>3){
      const pos = Math.min(w.length-2, Math.max(1, rnd(w.length-2)));
      tks[i].t = w.slice(0,pos)+w[pos]+w.slice(pos);
      answerIdx.add(i); made++;
    }
  }
  return { tokens:tks, answerIdx };
}

// Schulnote nach Punkten (0‚Äì50)
function toGrade(points){
  const r = (points/50)*100;
  if(r>=95) return 1;
  if(r>=80) return 2;
  if(r>=65) return 3;
  if(r>=50) return 4;
  if(r>=30) return 5;
  return 6;
}
function gradeText(note){
  return ({
    1:"Sehr gut ‚Äì hervorragende Leistung!",
    2:"Gut ‚Äì sehr solide!",
    3:"Befriedigend ‚Äì ordentlich gemacht.",
    4:"Ausreichend ‚Äì noch etwas √ºben.",
    5:"Mangelhaft ‚Äì dranbleiben, das wird!",
    6:"Ungen√ºgend ‚Äì nicht schlimm: √úbung hilft!"
  })[note];
}

function renderTokens(){
  textBox.innerHTML = '';
  state.tokens.forEach((tok, i)=>{
    const span = document.createElement('span');
    span.textContent = tok.t;
    if(tok.isWord) { span.className = 'token'; span.tabIndex = 0; }
    else { span.className=''; }
    span.dataset.idx = i;
    span.addEventListener('click', ()=>toggleSelect(i, span));
    span.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); toggleSelect(i, span);} });
    textBox.appendChild(span);
  });
}

function toggleSelect(i, elem){
  if(state.locked) return;
  if(!state.tokens[i].isWord) return;
  if(state.selectedIdx.has(i)){ state.selectedIdx.delete(i); elem.classList.remove('sel'); }
  else { state.selectedIdx.add(i); elem.classList.add('sel'); }
}

function setProgress(){
  roundEl.textContent = state.round.toString();
  pointsEl.textContent = state.points.toString();
  bar.style.width = (state.round*10)+'%';
}

function pickBase(theme){
  const arr = BASE_TEXTS[theme];
  // Vermeide direkte Wiederholung der letzten zwei
  let idx = rnd(arr.length);
  let guard = 0;
  while(state.usedIdx.slice(-2).includes(idx) && guard<20){ idx = rnd(arr.length); guard++; }
  state.usedIdx.push(idx);
  if(state.usedIdx.length>10) state.usedIdx.shift();
  return arr[idx];
}

function newRound(){
  if(!state.theme){ feedback.textContent = 'Bitte zuerst ein Thema w√§hlen.'; return; }
  if(state.round>=10){
    feedback.textContent = 'Thema abgeschlossen. Du kannst neu starten oder ein anderes Thema w√§hlen.';
    return;
  }
  const base = pickBase(state.theme);
  const origTokens = tokenize(base);
  const {tokens, answerIdx} = injectErrors(origTokens);
  state.tokens = tokens;
  state.answerIdx = answerIdx;
  state.selectedIdx = new Set();
  state.locked = false;
  renderTokens();
  feedback.innerHTML = `Markiere <strong>genau die 5 falschen W√∂rter</strong> und klicke <em>Pr√ºfen</em>.`;
  modeLabel.textContent = THEMES.find(t=>t.id===state.theme).title + ' ‚Äì Runde ' + (state.round+1);
}

function check(){
  if(!state.theme || state.tokens.length===0) return;
  if(state.locked) return;
  // Auswertung
  const sel = new Set(state.selectedIdx);
  const ans = new Set(state.answerIdx);
  // Visualisieren
  document.querySelectorAll('.token').forEach(sp=>{
    const i = Number(sp.dataset.idx);
    if(sel.has(i) && ans.has(i)){ sp.classList.add('good'); }
    else if(sel.has(i) && !ans.has(i)){ sp.classList.add('bad'); }
  });
  const tp = [...sel].filter(i=>ans.has(i)).length; // Treffer
  const fp = [...sel].filter(i=>!ans.has(i)).length; // falsche Markierungen
  const fn = [...ans].filter(i=>!sel.has(i)).length; // √ºbersehene
  // Punkte: +1 pro Treffer, -1 pro Fehlklick, Mindestwert 0 / Max 5
  let gained = Math.max(0, Math.min(5, tp - fp));
  state.points += gained;
  state.locked = true;
  state.round += 1;
  setProgress();
  // Ergebnis & Hinweis
  feedback.innerHTML = `‚úîÔ∏è Treffer: <strong>${tp}</strong> ‚Ä¢ ‚ùå Fehltreffer: <strong>${fp}</strong> ‚Ä¢ üôà √úbersehen: <strong>${fn}</strong> &nbsp; ‚Üí <strong>+${gained} Punkt${gained===1?'':'e'}</strong>`;
  // Wenn Thema fertig, Note anzeigen
  if(state.round===10){
    const grade = toGrade(state.points);
    resultTheme.textContent = THEMES.find(t=>t.id===state.theme).title;
    resultPoints.textContent = `${state.points}`;
    resultGrade.textContent = `${grade}`;
    resultText.textContent = gradeText(grade);
  }
}

function next(){
  if(!state.theme) return;
  if(!state.locked){
    feedback.textContent = 'Bitte zuerst ‚ÄûPr√ºfen‚Äú klicken.';
    return;
  }
  // Reset Styles
  document.querySelectorAll('.token').forEach(sp=>sp.classList.remove('good','bad','sel'));
  if(state.round<10) newRound();
  else feedback.textContent = 'Thema abgeschlossen. W√§hle ein neues Thema oder setze das Spiel zur√ºck.';
}

function resetGame(full=false){
  state.round = 0; state.points = 0;
  state.tokens = []; state.answerIdx = new Set(); state.selectedIdx = new Set();
  state.locked = false; state.usedIdx = [];
  if(full) state.theme = null;
  textBox.textContent = state.theme ? 'Klicke ‚ÄûN√§chster Text‚Äú, um zu starten.' : 'Bitte w√§hle zuerst ein Thema.';
  feedback.textContent = '';
  setProgress();
  bar.style.width = '0%';
  resultTheme.textContent = '‚Äî'; resultPoints.textContent = '0'; resultGrade.textContent = '‚Äî';
  resultText.textContent = 'Starte ein Thema, um dein Ergebnis zu sehen.';
  modeLabel.textContent = state.theme ? THEMES.find(t=>t.id===state.theme).title : 'Thema w√§hlen';
}

/* =========================================
   UI initialisieren
========================================= */
function buildThemeButtons(){
  themeButtonsWrap.innerHTML = '';
  THEMES.forEach(th=>{
    const btn = document.createElement('button');
    btn.textContent = th.title;
    btn.addEventListener('click', ()=>{
      state.theme = th.id;
      resetGame(false);
      modeLabel.textContent = th.title;
      resultTheme.textContent = th.title;
      newRound();
    });
    themeButtonsWrap.appendChild(btn);
  });
}
buildThemeButtons();
setProgress();

/* =========================================
   Buttons
========================================= */
checkBtn.addEventListener('click', check);
nextBtn.addEventListener('click', next);
resetBtn.addEventListener('click', ()=>resetGame(true));
</script>
</body>
</html>
